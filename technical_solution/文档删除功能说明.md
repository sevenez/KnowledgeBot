# 文档删除功能说明

## 概述

FastAPI文档处理器提供了完整的文档删除功能，支持批量删除文档及其相关的所有数据，包括向量记录、预处理文件和数据库记录。

## 核心功能

### 批量删除文档接口 (`DELETE /documents`)

**功能描述**: 
- 批量删除指定文件路径的文档
- 自动清理相关的向量数据
- 删除预处理生成的Markdown文件
- 清理数据库中的所有相关记录

**请求格式**:
```json
{
  "file_paths": [
    "path/to/document1.pdf",
    "path/to/document2.docx",
    "path/to/document3.txt"
  ]
}
```

**响应格式**:
```json
{
  "batch_id": "delete-batch-uuid",
  "timestamp": 1693478500.0,
  "results": [
    {
      "file_path": "path/to/document1.pdf",
      "vector_deleted": true,
      "md_file_deleted": true,
      "error": null
    },
    {
      "file_path": "path/to/document2.docx",
      "vector_deleted": true,
      "md_file_deleted": false,
      "error": null
    },
    {
      "file_path": "path/to/nonexistent.txt",
      "vector_deleted": false,
      "md_file_deleted": false,
      "error": "文件不存在"
    }
  ]
}
```

## 删除流程详解

### 1. 文件验证
- 检查每个文件路径是否存在
- 对不存在的文件记录错误信息
- 继续处理其他有效文件

### 2. 数据库记录删除
按以下顺序删除数据库记录：

1. **查询文档ID**
   ```sql
   SELECT id FROM documents WHERE path = %s
   ```

2. **删除命名实体记录**
   ```sql
   DELETE FROM named_entities 
   WHERE chunk_id IN (
     SELECT id FROM document_chunks WHERE file_id = %s
   )
   ```

3. **删除文档切片记录**
   ```sql
   DELETE FROM document_chunks WHERE file_id = %s
   ```

4. **删除文档主记录**
   ```sql
   DELETE FROM documents WHERE id = %s
   ```

### 3. 向量数据库清理
- 从Milvus向量数据库中删除相关向量
- 使用文档ID构建删除表达式
- 自动处理向量索引更新

### 4. 预处理文件清理
- 对于需要预处理的文件格式（.doc, .docx, .pdf）
- 自动查找并删除对应的.md文件
- .md文件路径规则：与源文件同目录，同名但扩展名为.md

## 响应字段说明

### 批量删除响应
- `batch_id`: 删除批次的唯一标识符
- `timestamp`: 删除操作的时间戳
- `results`: 每个文件的删除结果数组

### 单个文件删除结果
- `file_path`: 文件路径
- `vector_deleted`: 向量数据是否成功删除
- `md_file_deleted`: 预处理Markdown文件是否删除
- `error`: 错误信息（如果有）

## 使用示例

### Python客户端示例

```python
import requests

def delete_documents(file_paths):
    """删除指定的文档文件"""
    
    delete_request = {
        "file_paths": file_paths
    }
    
    try:
        response = requests.delete(
            "http://localhost:7870/documents",
            json=delete_request,
            headers={"Content-Type": "application/json"}
        )
        
        if response.status_code == 200:
            result = response.json()
            print(f"删除批次ID: {result['batch_id']}")
            
            # 分析删除结果
            for item in result['results']:
                file_path = item['file_path']
                if item['error']:
                    print(f"❌ {file_path}: {item['error']}")
                else:
                    print(f"✅ {file_path}: 删除成功")
                    print(f"   向量删除: {'是' if item['vector_deleted'] else '否'}")
                    print(f"   MD文件删除: {'是' if item['md_file_deleted'] else '否'}")
            
            return True
        else:
            print(f"删除请求失败: {response.status_code}")
            print(f"错误信息: {response.text}")
            return False
            
    except requests.exceptions.RequestException as e:
        print(f"网络请求失败: {e}")
        return False

# 使用示例
files_to_delete = [
    "documents/old_report.pdf",
    "documents/outdated_manual.docx",
    "documents/temp_data.txt"
]

delete_documents(files_to_delete)
```

### cURL示例

```bash
# 删除单个文档
curl -X DELETE "http://localhost:7870/documents" \
  -H "Content-Type: application/json" \
  -d '{
    "file_paths": ["path/to/document.pdf"]
  }'

# 批量删除多个文档
curl -X DELETE "http://localhost:7870/documents" \
  -H "Content-Type: application/json" \
  -d '{
    "file_paths": [
      "documents/report1.pdf",
      "documents/manual.docx",
      "documents/data.xlsx"
    ]
  }'
```

### JavaScript/Node.js示例

```javascript
const axios = require('axios');

async function deleteDocuments(filePaths) {
    try {
        const response = await axios.delete('http://localhost:7870/documents', {
            data: {
                file_paths: filePaths
            },
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = response.data;
        console.log(`删除批次ID: ${result.batch_id}`);
        
        // 处理删除结果
        result.results.forEach(item => {
            if (item.error) {
                console.log(`❌ ${item.file_path}: ${item.error}`);
            } else {
                console.log(`✅ ${item.file_path}: 删除成功`);
                console.log(`   向量删除: ${item.vector_deleted ? '是' : '否'}`);
                console.log(`   MD文件删除: ${item.md_file_deleted ? '是' : '否'}`);
            }
        });
        
        return true;
    } catch (error) {
        console.error('删除文档失败:', error.message);
        return false;
    }
}

// 使用示例
const filesToDelete = [
    'documents/old_report.pdf',
    'documents/outdated_manual.docx'
];

deleteDocuments(filesToDelete);
```

## 错误处理

### 常见错误类型

1. **文件不存在**
   - 错误信息: "文件不存在"
   - 处理方式: 跳过该文件，继续处理其他文件

2. **数据库连接失败**
   - 错误信息: "数据库连接失败: [具体错误]"
   - 处理方式: 检查MySQL配置和连接状态

3. **向量数据库删除失败**
   - 错误信息: "从Milvus删除向量失败: [具体错误]"
   - 处理方式: 检查Milvus服务状态

4. **文件权限问题**
   - 错误信息: "删除关联md文件失败: [权限错误]"
   - 处理方式: 检查文件系统权限

### 错误恢复策略

1. **部分删除成功**: 系统会继续处理其他文件，不会因单个文件失败而中断
2. **事务回滚**: 数据库操作使用事务，确保数据一致性
3. **详细日志**: 所有删除操作都会记录详细日志便于调试

## 安全考虑

### 权限控制
- 确保API服务有足够权限访问文件系统
- 验证文件路径的合法性，防止路径遍历攻击
- 建议在生产环境中添加身份验证

### 数据备份
- 删除操作不可逆，建议在删除前进行数据备份
- 可以考虑实现软删除机制（标记为删除而非物理删除）

### 批量限制
- 建议限制单次删除的文件数量，避免系统负载过高
- 可以添加删除频率限制

## 监控和日志

### 日志记录
```
2025-08-31 17:00:01 - INFO - 开始删除文档: /path/to/document.pdf
2025-08-31 17:00:02 - INFO - 成功删除文件路径 /path/to/document.pdf 的所有向量记录
2025-08-31 17:00:02 - INFO - 已删除关联的md文件: /path/to/document.md
2025-08-31 17:00:03 - INFO - 文档删除完成: /path/to/document.pdf
```

### 性能监控
- 删除操作耗时统计
- 数据库操作性能监控
- 文件系统操作监控

## 最佳实践

1. **批量删除**: 尽量批量删除而非逐个删除，提高效率
2. **错误检查**: 删除前验证文件路径和权限
3. **日志审计**: 保留删除操作的审计日志
4. **定期清理**: 定期清理孤立的向量数据和索引文件
5. **备份策略**: 重要数据删除前进行备份

## 故障排除

### 常见问题及解决方案

1. **删除操作卡住**
   - 检查数据库连接状态
   - 查看是否有长时间运行的事务
   - 重启相关服务

2. **部分数据未删除**
   - 检查数据库表的外键约束
   - 验证向量数据库连接状态
   - 查看详细错误日志

3. **性能问题**
   - 减少单次删除的文件数量
   - 优化数据库索引
   - 考虑异步删除机制

## 版本兼容性

- 支持的数据库版本: MySQL 5.7+
- 支持的向量数据库: Milvus 2.0+
- Python版本要求: 3.8+
- FastAPI版本: 0.68+